<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>í”„ë¡œí•„ ì‘ì„±</title>
  <link rel="stylesheet" href="profile.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="fixed812"><!-- ë””ìì¸ í™•ì¸ìš© 375Ã—812 ê³ ì •. ë°°í¬ ì‹œ ì´ í´ë˜ìŠ¤ ì œê±° -->
  <div class="app">
    <!-- ìƒë‹¨ í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

    <!-- ìƒë‹¨ 44px ì—¬ë°± ì•„ë˜ì— ë°°ì¹˜ëœ ì´ì „ ë²„íŠ¼ -->
    <div class="topbar">
      <button class="nav-back" type="button" aria-label="ì´ì „" onclick="history.back()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M15 18l-6-6 6-6" stroke="#111" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <main class="container form-container">
      <!-- í”„ë¡œí•„ ì‚¬ì§„(ì„ íƒ) ì¤‘ì•™ -->
      <label class="avatar-uploader" for="avatar" aria-label="í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë¡œë“œ"></label>
      <input id="avatar" name="avatar" type="file" accept="image/*">

      <form id="profile-form" class="form" action="#" method="post" novalidate>
        <!-- ë‹‰ë„¤ì„ -->
        <div class="field" id="field-nickname">
          <div class="label-row">
            <label for="nickname">ë‹‰ë„¤ì„</label>
            <span class="count" data-count>0/15</span>
          </div>
        <input id="nickname" name="nickname" type="text" maxlength="15"
               placeholder="15ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”" required aria-invalid="false">
        </div>

        <!-- í•œ ì¤„ ì†Œê°œ -->
        <div class="field" id="field-bio">
          <div class="label-row"><label for="bio">í•œ ì¤„ ì†Œê°œ</label></div>
          <input id="bio" name="bio" type="text" placeholder="ë‚˜ì˜ ê³µê°„ì„ ì¡´ì¤‘í•´ì¤˜ìš” ğŸŒµ"
                 required aria-invalid="false">
        </div>

        <!-- ì´ë©”ì¼ -->
        <div class="field" id="field-email">
          <div class="label-row"><label for="email">ì´ë©”ì¼</label></div>
          <input id="email" name="email" type="email" placeholder="you@example.com"
                 required aria-invalid="false" inputmode="email" autocomplete="email">
        </div>

        <!-- ê³µê°œ/ë¹„ê³µê°œ -->
        <div class="field">
          <div class="label-row"><label>ê³µê°œ ë²”ìœ„</label></div>
          <div class="pills" role="group" aria-label="ê³µê°œ ë²”ìœ„ ì„ íƒ">
            <button type="button" class="pill is-active" data-value="public">ê³µê°œ</button>
            <button type="button" class="pill" data-value="private">ë¹„ê³µê°œ</button>
          </div>
          <input type="hidden" name="visibility" id="visibility" value="public">
        </div>
      </form>
    </main>

    <div class="cta-wrap">
      <!-- í´ë¦­ ì‹œ ê°•ì œ ì œì¶œ -->
      <button id="saveBtn" class="cta" type="button">ì €ì¥</button>
    </div>
  </div>

  <script>
    // ---- ìš”ì†Œ ì°¸ì¡° ----
    const form = document.getElementById('profile-form');
    const toast = document.getElementById('toast');
    const avatarInput = document.getElementById('avatar');   // ì„ íƒ(í•„ìˆ˜ ì•„ë‹˜)
    const uploader = document.querySelector('.avatar-uploader');
    const nick = document.getElementById('nickname');
    const bio  = document.getElementById('bio');
    const email= document.getElementById('email');
    const cnt  = document.querySelector('[data-count]');
    const pills= document.querySelectorAll('.pill');
    const visibility = document.getElementById('visibility');
    const saveBtn = document.getElementById('saveBtn');

    // ---- ë‹‰ë„¤ì„ ê¸€ììˆ˜ ----
    function updateCnt(){ cnt.textContent = `${nick.value.length}/15`; }
    nick.addEventListener('input', updateCnt); updateCnt();

    // ---- ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ ----
    pills.forEach(b=>b.addEventListener('click', (e)=>{
      pills.forEach(x=>x.classList.remove('is-active'));
      e.currentTarget.classList.add('is-active');
      visibility.value = e.currentTarget.dataset.value;
    }));

    // ---- ì•„ë°”íƒ€ ë¯¸ë¦¬ë³´ê¸° (ì„ íƒ) ----
    avatarInput.addEventListener('change', () => {
      const file = avatarInput.files && avatarInput.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      uploader.style.backgroundImage = `url("${url}")`;
      uploader.style.backgroundSize = 'cover';
      uploader.style.backgroundPosition = 'center';
    });

    // ---- í† ìŠ¤íŠ¸ ----
    let toastTimer = null;
    function showToast(message){
      toast.textContent = message;
      toast.classList.add('is-show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove('is-show'), 2500);
    }

    // ---- ìœ íš¨ì„± ê²€ì‚¬ (ì•„ë°”íƒ€ ì œì™¸) ----
    const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    function markInvalid(inputEl, isInvalid){
      inputEl.setAttribute('aria-invalid', isInvalid ? 'true' : 'false');
      const wrap = inputEl.closest('.field');
      if(!wrap) return;
      wrap.classList.toggle('invalid', !!isInvalid);
    }
    function validateAll(){
      let ok = true;
      if(nick.value.trim().length === 0){ markInvalid(nick, true); ok = false; } else { markInvalid(nick, false); }
      if(bio.value.trim().length  === 0){ markInvalid(bio,  true); ok = false; } else { markInvalid(bio,  false); }
      const v = email.value.trim();
      if(v.length === 0 || !EMAIL_RE.test(v)){ markInvalid(email, true); ok = false; } else { markInvalid(email, false); }
      return ok;
    }

    // ---- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ----
    async function fileToDataURL(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    async function saveProfile(){
      let avatarDataUrl = null;
      // í˜„ì¬ í‘œì‹œ ì¤‘ ì´ë¯¸ì§€ê°€ dataURLì´ë©´ ìœ ì§€
      const styleBg = uploader.style.backgroundImage;
      if(styleBg && styleBg.startsWith('url("data:')) {
        avatarDataUrl = styleBg.slice(5, -2); // url("...") â†’ ...
      }
      // ìƒˆë¡œ ì—…ë¡œë“œí•˜ë©´ êµì²´
      if (avatarInput.files && avatarInput.files[0]) {
        try{ avatarDataUrl = await fileToDataURL(avatarInput.files[0]); }catch(e){}
      }

      const data = {
        nickname: nick.value.trim(),
        bio:      bio.value.trim(),
        email:    email.value.trim(),
        visibility: visibility.value,
        avatar:   avatarDataUrl,           // ì„ íƒì‚¬í•­
        savedAt:  new Date().toISOString()
      };
      localStorage.setItem('profile', JSON.stringify(data));
    }

    function loadProfile(){
      try{
        const raw = localStorage.getItem('profile');
        if(!raw) return;
        const data = JSON.parse(raw);
        if(typeof data.nickname === 'string'){ nick.value = data.nickname; }
        if(typeof data.bio      === 'string'){ bio.value  = data.bio; }
        if(typeof data.email    === 'string'){ email.value= data.email; }
        if(typeof data.visibility === 'string'){
          pills.forEach(x=>x.classList.toggle('is-active', x.dataset.value===data.visibility));
          visibility.value = data.visibility;
        }
        if(data.avatar){
          uploader.style.backgroundImage = `url("${data.avatar}")`;
          uploader.style.backgroundSize = 'cover';
          uploader.style.backgroundPosition = 'center';
        }
      }catch(e){}
      updateCnt();
    }

    document.addEventListener('DOMContentLoaded', loadProfile);

    // ---- ë²„íŠ¼ í´ë¦­ â†’ ê°•ì œ ì œì¶œ (ë¸Œë¼ìš°ì € í˜¸í™˜ìš©) ----
    saveBtn.addEventListener('click', (ev)=>{
      ev.preventDefault();
      form.requestSubmit(); // í•­ìƒ submit ì´ë²¤íŠ¸ë¥¼ íƒ€ê²Œ í•¨
    });

    // ---- submit í•¸ë“¤ëŸ¬: ê²€ì¦ â†’ ì €ì¥ â†’ indexë¡œ ì´ë™ ----
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const ok = validateAll();
      if(!ok){
        if(nick.getAttribute('aria-invalid')==='true')      showToast('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        else if(bio.getAttribute('aria-invalid')==='true')  showToast('í•œ ì¤„ ì†Œê°œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        else if(email.getAttribute('aria-invalid')==='true')showToast('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        const firstErr = document.querySelector('.field.invalid input');
        firstErr?.focus();
        return;
      }
      try{
        await saveProfile();
      }finally{
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
